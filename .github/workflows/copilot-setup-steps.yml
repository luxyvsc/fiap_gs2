name: "Copilot Setup Steps"

# This workflow runs setup, validation, and testing steps for the FIAP AI-Enhanced Learning Platform
# It supports the multi-language stack (Python, Flutter, R) and follows the project's coding standards

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml


jobs:

  copilot-setup-steps:
    runs-on: ubuntu-latest

    permissions:
      # If you want to clone the repository as part of your setup steps, for example to install dependencies, you'll need the `contents: read` permission. If you don't clone the repository in your setup steps, Copilot will do this for you automatically after the steps complete.
      contents: read


    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Check Python Version
        run: python --version

      - name: Install Python dependencies
        run: |
          # Instalar dependências globais se houver requirements.txt na raiz
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
          # Instalar pacotes Python em modo editável
          for package in packages/*/; do
            if [ -f "$package/pyproject.toml" ] && [ -d "$package/src" ]; then
              cd "$package"
              pip install -e ".[dev]"
              cd ../..
            fi
          done

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'
          cache: true

      - name: Check Flutter Version
        run: flutter --version

      - name: Install Flutter dependencies
        run: |
          # Instalar dependências Flutter
          for package in packages_dashboard/*/; do
            if [ -f "$package/pubspec.yaml" ]; then
              cd "$package"
              flutter pub get
              cd ../..
            fi
          done

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Ensure Java is installed (See https://github.com/actions/setup-java)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Start the Firebase Emulator Suite using explicit CLI steps (safer than relying on an external action)
      - name: Install firebase-tools
        run: |
          echo "Installing firebase-tools..."
          npm install -g firebase-tools@latest
          firebase --version || true

      - name: Start Firebase Emulators (background)
        run: |
          echo "Starting Firebase Emulator Suite in background..."
          # Start emulators in background and capture logs and PID
          nohup firebase emulators:start --only auth,firestore,functions,storage,database --project test-project > emulators.log 2>&1 &
          echo $! > emulators.pid

      - name: Wait for Firebase Emulators to be ready
        run: |
          echo "Waiting for emulators to be ready (max 60s)..."
          for i in $(seq 1 60); do
            if grep -i "all emulators" emulators.log >/dev/null 2>&1 || grep -i "emulators started" emulators.log >/dev/null 2>&1; then
              echo "Firebase Emulators ready after $i seconds"
              break
            fi
            sleep 1
          done
          if [ ! -s emulators.log ]; then
            echo "⚠️ emulators.log is empty; emulator may have failed to start"
            tail -n 200 emulators.log || true
            exit 1
          fi

      - name: Show emulator log tail
        run: |
          echo "--- emulators.log (tail) ---"
          tail -n 200 emulators.log || true
